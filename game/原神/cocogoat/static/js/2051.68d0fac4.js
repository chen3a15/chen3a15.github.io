"use strict";(self["define"]=self["define"]||[]).push([[2051],{35200:function(e,t,a){a.d(t,{zG:function(){return h}});var n=a(35512),l=a(19390),i=a(44847),o=a(7728),s=a(28341),c=a(15748),r=a(3146),u=a(40586);function d(){const e=(0,o.G)((()=>(console.log("[worker-macro] webpack"),new o.G(new URL(a.p+a.u(1584),a.b))))),t=(0,n.Ud)(e);return{worker:t,_worker:e}}function v(){const{worker:e,_worker:t}=d(),{worker:a,_worker:n}=d(),{scannerOnImage:o,scannerOnLine:v,recognizeAchievement:w}=e,{recognizeAchievement:h,scannerOnLine:m}=a;let f=(e,t)=>{};const p=e=>{f=e},g=e=>{throw f(-99),e};t.addEventListener("error",g),n.addEventListener("error",g);const y=(async()=>{try{const[t,n]=(0,i.LS)(),o=s.hasSIMD?"ort-wasm-simd.wasm":"ort-wasm.wasm",d=s.hasSIMD?"opencv-simd.wasm":"opencv-normal.wasm";await t,await(0,i.sB)([o,d,"ppocr.ort"],(e=>f(e)),n);const v=(0,u.Z)(r.ag.amos);await Promise.all([e.setResources(l.ZP),a.setResources(l.ZP),e.initAchievementMap(c["default"],v),a.initAchievementMap(c["default"],v)]),f(100)}catch(o){throw f(-1,o),o}t.removeEventListener("error",g),n.removeEventListener("error",g),await Promise.all([e.init(),a.init()])})();return{recognizeAchievement:h,recognizeAchievement2:w,scannerOnLine:m,scannerOnLine2:v,scannerOnImage:o,initPromise:y,workerCV:e,workerOCR:a,onProgress:p}}let w;function h(){return w||(w=v()),w}},77689:function(e,t,a){a.d(t,{l:function(){return l}});var n=a(29715);function l(e,t){return n.l(e,t,"achievement")}},88874:function(e,t,a){a.r(t),a.d(t,{default:function(){return ce}});var n=a(10311);const l={key:0},i={key:1,style:{"padding-top":"20px"}},o={class:"inline-status"},s={key:1,class:"pbar"},c={key:0,class:"pbar-bar-text"};function r(e,t,a,r,u,d){const v=(0,n.resolveComponent)("Loader"),w=(0,n.resolveComponent)("float-content-b"),h=(0,n.resolveComponent)("web-capturer"),m=(0,n.resolveComponent)("float-content"),f=(0,n.resolveComponent)("c-ready");return(0,n.openBlock)(),(0,n.createElementBlock)("main",null,[e.state===e.S.Init?((0,n.openBlock)(),(0,n.createElementBlock)("section",l,[(0,n.createVNode)(v,{source:"achievement",instance:e.getScannerInstance,onDone:t[0]||(t[0]=t=>e.state++)},null,8,["instance"])])):((0,n.openBlock)(),(0,n.createElementBlock)("section",i,[((0,n.openBlock)(),(0,n.createBlock)(h,{ref:"cap",key:e.capKey,popup:e.state===e.S.Wait||e.state===e.S.Capture,onExit:t[1]||(t[1]=t=>e.state=e.S.Processing),onReady:t[2]||(t[2]=t=>e.state=e.S.Wait)},{default:(0,n.withCtx)((()=>[(0,n.createVNode)(w,{capture:e.capture,state:e.state===e.S.Capture?1:0,success:e.recognized.success,fail:e.recognized.fail,scanned:e.scanned,duplicate:e.dup,webControlEnabled:e.webControlEnabled},null,8,["capture","state","success","fail","scanned","duplicate","webControlEnabled"])])),_:1},8,["popup"])),e.state>e.S.Wait?((0,n.openBlock)(),(0,n.createElementBlock)("div",{key:0,class:(0,n.normalizeClass)(e.$style.statusInner)},[(0,n.createElementVNode)("div",o,[(0,n.createVNode)(m,{"in-float":!1,capture:!1,state:1,success:e.recognized.success,fail:e.recognized.fail,scanned:e.scanned,duplicate:e.dup,onClick:t[3]||(t[3]=t=>e.state===e.S.Capture&&(e.state=e.S.Processing))},null,8,["success","fail","scanned","duplicate"])]),e.state===e.S.Capture?((0,n.openBlock)(),(0,n.createElementBlock)("div",{key:0,class:"no-box",onClick:t[4]||(t[4]=t=>e.state===e.S.Capture&&(e.state=e.S.Processing))},(0,n.toDisplayString)(e.webControlEnabled>0?"自动滚动进行中":"请按手动匀速滚动页面，完成后点此结束"),1)):(0,n.createCommentVNode)("",!0),e.state>e.S.Capture?((0,n.openBlock)(),(0,n.createElementBlock)("div",s,[(0,n.createElementVNode)("div",{class:(0,n.normalizeClass)(["pbar-bar",{finish:e.state===e.S.Finish}])},[(0,n.createElementVNode)("div",{class:"pbar-bar-in",style:(0,n.normalizeStyle)({width:(e.recognized.success+e.recognized.fail+e.dup)/e.scanned*100+"%"})},null,4),e.state===e.S.Finish?((0,n.openBlock)(),(0,n.createElementBlock)("div",c,"完成")):(0,n.createCommentVNode)("",!0)],2),e.state===e.S.Finish?((0,n.openBlock)(),(0,n.createElementBlock)("div",{key:0,class:"restart",onClick:t[5]||(t[5]=(...t)=>e.reset&&e.reset(...t))},"重新开始")):(0,n.createCommentVNode)("",!0)])):(0,n.createCommentVNode)("",!0)],2)):(0,n.createCommentVNode)("",!0),e.state===e.S.Wait?((0,n.openBlock)(),(0,n.createBlock)(f,{key:1,onDone:t[6]||(t[6]=t=>e.state=e.S.Capture)})):(0,n.createCommentVNode)("",!0)]))])}a(16329),a(77253);var u=a(33314),d=a(87860),v=a(35200),w=a(41151);function h(e,t,a,l,i,o){return(0,n.openBlock)(),(0,n.createElementBlock)("div")}const m="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1024 1024' fill='%23fff'%3E%3Cpath d='M421.646 361.414v-93.081c0-7.562 2.678-13.996 8.038-19.366 5.354-5.346 11.812-8.022 19.366-8.022h246.373c7.562 0 14.012 2.676 19.356 8.022 5.37 5.372 8.038 11.804 8.038 19.366v246.405c0 7.554-2.668 13.988-8.038 19.358-5.346 5.328-11.794 8.024-19.356 8.024H602.35v202.605c0 10.576-3.736 19.582-11.254 27.102-7.484 7.462-16.514 11.232-27.1 11.232H219.07c-10.574 0-19.616-3.77-27.112-11.232-7.508-7.52-11.254-16.526-11.254-27.102V399.758c0-10.588 3.748-19.594 11.254-27.112 7.496-7.484 16.538-11.232 27.112-11.232h202.573zm0 60.234H279.31c-10.574 0-19.618 3.748-27.112 11.232-7.508 7.52-11.254 16.526-11.254 27.112v224.497c0 10.576 3.748 19.582 11.254 27.102 7.494 7.462 16.538 11.232 27.112 11.232h224.455c10.586 0 19.616-3.77 27.1-11.232 7.52-7.52 11.254-16.526 11.254-27.102V542.118h-93.066c-7.554 0-14.012-2.694-19.366-8.024-5.362-5.37-8.038-11.804-8.038-19.358v-93.088zm87.64-120.47c-7.554 0-14.012 2.678-19.366 8.024-5.362 5.37-8.038 11.804-8.038 19.368v125.936c0 7.554 2.678 13.988 8.038 19.358 5.354 5.33 11.812 8.024 19.366 8.024h125.906c7.562 0 14.012-2.694 19.356-8.024 5.37-5.37 8.037-11.804 8.037-19.358V328.57c0-7.562-2.667-13.996-8.037-19.368-5.346-5.346-11.794-8.024-19.356-8.024H509.288zM225.169 85.038l-49.932-28.83c-14.406-8.319-19.342-26.737-11.024-41.14s26.736-19.343 41.14-11.025l104.332 60.234c14.404 8.318 19.342 26.736 11.024 41.14L260.473 209.75c-8.318 14.406-26.736 19.342-41.14 11.024s-19.342-26.736-11.024-41.14l23.282-40.326c-40.44 15.522-74.804 37.426-103.092 65.712-42.704 42.704-71.337 99.733-85.903 171.087L.002 333.512c14.744-71.535 43.36-128.545 85.85-171.037 36.211-36.212 82.65-62.026 139.315-77.442zm536.998 808.386l49.932 28.828c14.404 8.318 19.342 26.736 11.024 41.14s-26.736 19.342-41.14 11.024L677.651 914.18c-14.404-8.318-19.341-26.736-11.024-41.14l60.236-104.331c8.318-14.404 26.736-19.342 41.14-11.024s19.342 26.736 11.024 41.14l-23.282 40.326c40.44-15.52 74.804-37.424 103.092-65.712 42.704-42.704 71.338-99.734 85.904-171.09l42.591 42.592c-14.744 71.534-43.36 128.548-85.85 171.038-36.211 36.212-82.649 62.025-139.315 77.441z'/%3E%3C/svg%3E",f="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1024 1024' fill='%23fff'%3E%3Cpath d='M468.867 212.468a43.133 43.133 0 1 0 86.266 0 43.133 43.133 0 1 0-86.266 0zM468.867 383.4a43.133 43.133 0 1 0 86.266 0 43.133 43.133 0 1 0-86.266 0zM468.867 554.334a43.133 43.133 0 1 0 86.266 0 43.133 43.133 0 1 0-86.266 0zM609.448 651.782L512 749.229l-97.448-97.447c-17.572-17.573-43.132-17.573-59.107 0s-17.573 43.132 0 59.107l127.8 127.8c7.987 7.988 20.767 12.78 30.353 12.78s20.767-4.792 30.352-12.78l127.8-127.8c17.573-17.572 17.573-43.132 0-59.107-19.17-17.573-44.73-17.573-62.302 0z'/%3E%3Cpath d='M555.133 0h-84.668C302.727 0 171.732 132.593 171.732 298.733v426.534c0 166.14 132.592 298.733 298.733 298.733h84.668c166.14 0 298.733-132.593 298.733-298.733V298.733C852.268 132.593 721.273 0 555.133 0zM767.6 723.67c0 119.812-94.253 212.467-212.468 212.467h-84.668c-119.813 0-212.468-94.252-212.468-212.468V298.733c0-119.813 94.253-212.468 212.468-212.468h84.668c119.812 0 212.468 94.253 212.468 212.468V723.67z'/%3E%3C/svg%3E",p=new Image;p.src=m;const g=new Image;g.src=f;var y=(0,n.defineComponent)({props:{state:Number,success:Number,fail:Number,duplicate:Number,scanned:Number,webControlEnabled:Number},setup(e){const t=(0,n.inject)("canvas");function a(){const e=t.value.getContext("2d");e.textAlign="left",e.fillStyle="#fff",e.fillRect(0,0,t.value.width,t.value.height),e.fillStyle="#7e7e7e",e.fillRect(0,0,.28*t.value.width,t.value.height),e.drawImage(p,.05*t.value.width,.112*t.value.width,.18*t.value.width,.18*t.value.width),e.fillStyle="#999",e.font=.056*t.value.width+"px 微软雅黑",e.fillText("请切换到游戏窗口",.42*t.value.width,.18*t.value.width),e.fillText("打开任意成就页面",.42*t.value.width,.26*t.value.width)}function l(){const a=t.value.getContext("2d");a.textAlign="left",a.fillStyle="#fff",a.fillRect(0,0,t.value.width,t.value.height),a.fillStyle="#4096fe",a.fillRect(0,0,.28*t.value.width,t.value.height),a.drawImage(g,.05*t.value.width,.112*t.value.width,.18*t.value.width,.18*t.value.width),a.font=.044*t.value.width+"px 微软雅黑",e.webControlEnabled&&e.webControlEnabled>0?(a.fillText("自动翻页进行中，请勿移动鼠标",.348*t.value.width,.292*t.value.width),a.fillText("如需中断，请按 Win 键停止识别",.356*t.value.width,.352*t.value.width)):(a.fillText("匀速向下翻页 完成后点此结束",.348*t.value.width,.292*t.value.width),a.fillText("尽量将鼠标保持在左侧图标处",.356*t.value.width,.352*t.value.width)),a.fillText("扫描",.34*t.value.width,.092*t.value.width),a.fillStyle="#00b57a",a.fillText("成功",.508*t.value.width,.092*t.value.width),a.fillStyle="#cf0000",a.fillText("失败",.676*t.value.width,.092*t.value.width),a.fillStyle="#999",a.fillText("重复",.844*t.value.width,.092*t.value.width),i()}function i(){if(0===e.state)return;const a=t.value.getContext("2d");a.fillStyle="#fff",a.fillRect(.28*t.value.width,.112*t.value.width,.72*t.value.width,.12*t.value.width),a.font=.08*t.value.width+"px 微软雅黑",a.textAlign="center",a.fillStyle="#4096fe",a.fillText((e.scanned||0).toString(),.38*t.value.width,.2*t.value.width),a.fillStyle="#00b57a",a.fillText((e.success||0).toString(),.552*t.value.width,.2*t.value.width),a.fillStyle="#cf0000",a.fillText((e.fail||0).toString(),.72*t.value.width,.2*t.value.width),a.fillStyle="#999",a.fillText((e.duplicate||0).toString(),.888*t.value.width,.2*t.value.width)}return(0,n.watch)((()=>e.state),(e=>{0===e?a():l()})),(0,n.watch)(e,(()=>{i()}),{deep:!0}),(0,n.onMounted)((()=>{0===e.state?a():l()})),{}}}),C=a(14545);const E=(0,C.Z)(y,[["render",h]]);var k=E,b=a(77689),S=a(1533),x=a.n(S),B=a(48243),N=a(2849),V=a(65890),L=a(48206),I=a(96181),z=a(25194),P=a(57385),T=a(29056),M=(a(60388),a(84136));a(36805);const R={class:"content"},F=(0,n.createElementVNode)("div",{class:"title"},"还差最后一步",-1),W={class:"desc"},A=(0,n.createTextVNode)(" 请手动切换到成就列表界面，然后点击下面按钮继续 "),_=(0,n.createElementVNode)("br",null,null,-1),D={key:0},O={key:1},U={key:2},Z={class:"l"},H={class:"m"},q=(0,n.createElementVNode)("div",{class:"t"},"我已打开成就列表界面",-1),G={key:0,class:"d"},$={key:1,class:"d"},K={class:"r"};function j(e,t,a,l,i,o){const s=M.v,c=(0,n.resolveComponent)("fa-icon"),r=T.mi;return(0,n.openBlock)(),(0,n.createElementBlock)("div",{class:(0,n.normalizeClass)(e.$style.ready)},[(0,n.createElementVNode)("div",R,[F,(0,n.createElementVNode)("div",W,[A,_,e.hasPictureInPicture?((0,n.openBlock)(),(0,n.createElementBlock)("div",D,"如果没有看到悬浮窗，请点击页面空白处")):e.windowId>0?((0,n.openBlock)(),(0,n.createElementBlock)("div",O,[(0,n.createVNode)(s,{title:"当前浏览器不支持悬浮窗",description:"如需中断扫描，请按 Win 键",type:"warning","show-icon":""})])):((0,n.openBlock)(),(0,n.createElementBlock)("div",U,[(0,n.createVNode)(s,{title:"当前浏览器不支持悬浮窗",description:"完成翻页后，请点击“停止共享屏幕”按钮或手动回到本窗口点击停止扫描",type:"warning","show-icon":""})]))])]),(0,n.createVNode)(r,{class:"start-btn start-gray",onClick:t[0]||(t[0]=t=>e.$emit("done"))},{default:(0,n.withCtx)((()=>[(0,n.createElementVNode)("div",Z,[(0,n.createVNode)(c,{icon:"toggle-on"})]),(0,n.createElementVNode)("div",H,[q,e.windowId>0?((0,n.openBlock)(),(0,n.createElementBlock)("div",G,"将自动切换到原神窗口并开始翻页")):((0,n.openBlock)(),(0,n.createElementBlock)("div",$,"点击后请回到原神窗口并手动匀速滚动页面"))]),(0,n.createElementVNode)("div",K,[(0,n.createVNode)(c,{icon:"angle-right"})])])),_:1})],2)}var Q=a(28341);L.library.add(N.WZW);var J=(0,n.defineComponent)({props:{windowId:{type:Number,default:0}},emits:["done"],setup(){return{hasPictureInPicture:Q.hasPictureInPicture}}}),X={ready:"ready-bbdcc7"};const Y={};Y["$style"]=X;const ee=(0,C.Z)(J,[["render",j],["__cssModules",Y]]);var te,ae=ee;function ne(e){return new Promise((t=>{let a=0;const n=()=>{a++>=e?t():requestAnimationFrame(n)};n()}))}(function(e){e[e["Fail"]=-1]="Fail",e[e["Init"]=0]="Init",e[e["Ready"]=1]="Ready",e[e["Request"]=2]="Request",e[e["Wait"]=3]="Wait",e[e["Capture"]=4]="Capture",e[e["Processing"]=5]="Processing",e[e["Finish"]=6]="Finish"})(te||(te={})),L.library.add(N.ik8,V.EPy);var le=(0,n.defineComponent)({name:"AchievementScanner",components:{FloatContent:w.Z,FloatContentB:k,Loader:I.Z,CReady:ae,WebCapturer:P.Z},setup(){const{scannerOnLine:e,scannerOnLine2:t,scannerOnImage:a,initPromise:l,workerCV:i,workerOCR:o}=(0,v.zG)(),s={scanner:"CaptureScanner",capturer:"WebCapturer",ua:navigator.userAgent,w:0,h:0},c=(0,B.useRoute)(),r=window===parent,w=(0,n.ref)(!1),h=(0,n.ref)([]),m=(0,n.ref)(0),f=(0,n.ref)(0),p=(0,n.computed)((()=>({success:h.value.filter((e=>e.success)).length,fail:h.value.filter((e=>!e.success)).length}))),g=async({line:a,thread:n})=>{if(a){let l=e;n&&L.value===te.Processing&&(N.concurrency=2,l=t);const i=await l(a);if(i.success){const e=h.value.find((e=>{if(!e.success)return!1;const t=e;return t.achievement.id===i.achievement.id}));i.done&&!c.query.withImage||(i.images={main:(0,d.rT)(a).toDataURL("image/webp")}),e?f.value++:h.value.push(i)}else i.images={main:(0,d.rT)(a).toDataURL("image/webp")},h.value.push(i),(new Image).src=i.images.main}L.value!==te.Processing&&await ne(25)},y=document.createElement("canvas"),C=y.getContext("2d");let E=null,k=0;const S=async({imageData:e,keepLastLine:t})=>{const n=await a((0,d.Q8)(e),t),l=m.value,i=n.reduce(((e,t)=>e+t.image.rows),0);let o=0;for(const a of n)a.image.rows>i/n.length*2/3&&((!E||o<2)&&(E=a,o++),N.push({line:a.image,thread:m.value%2===0}),m.value++);if(t&&N.push({line:null,thread:!1}),T.value>0&&(l===m.value?k++:k=Math.max(0,k-1),k>5))return k=0,void(L.value=te.Processing)},N=x().promise(g,1);N.drain=()=>{L.value===te.Processing&&(L.value=te.Finish)};const V=x().promise(S,1),L=(0,n.ref)(te.Init);l.then((()=>{L.value=te.Ready}));const I=(0,n.ref)(null),P=(0,n.ref)(Date.now()),T=(0,n.computed)((()=>I.value?I.value.windowId:-1));let M=new u.p;(0,n.watch)(I,(e=>{e&&(M=e.control)}));let R=new AbortController;const F=async()=>{if(!I.value)return;y.width=I.value.video.videoWidth,y.height=I.value.video.videoHeight,s.w=I.value.video.videoWidth,s.h=I.value.video.videoHeight;let e=null,t={x:0,y:0},a=-1;const n=async(n=!0)=>{if(e||(e=await i.getRect()),E&&e&&(t.x&&t.y||(t=await M.toAbsolute(T.value,e.x,e.y+E.y+2*E.image.rows/3,{dx:y.width,dy:y.height})),await M.SetCursorPos(t.x,t.y),await M.mouse_event(M.MOUSEEVENTF_LEFTDOWN,0,0,0),await M.mouse_event(M.MOUSEEVENTF_LEFTUP,0,0,0),n?await M.mouse_event(M.MOUSEEVENTF_WHEEL,0,0,-120,11):await M.mouse_event(M.MOUSEEVENTF_WHEEL,0,0,-120,2)),n){const e=Math.ceil(a>0?a:60);await ne(e/16)}},l=async()=>{console.log("->latency measurement start");const e=await(0,z.s)(i.diffCached,(()=>I.value.capture({x:0,y:0,w:0,h:0})),(()=>n(!1)));console.log("->latency measurement done",e),a=Math.min(160,Math.max(e.latency,80))};let o=!0;while(L.value===te.Capture)try{let e=null;while(!e)C&&C.drawImage(I.value.video,0,0,y.width,y.height),e=C&&C.getImageData(0,0,y.width,y.height),e||(console.warn("->capture FAILD"),await ne(4));V.push({imageData:e,keepLastLine:!1}),T.value?o?(await ne(4),await n(!1),await ne(8),o=!1):await(a>0?n():l()):(await(0,z.h)(i.diffCached,(()=>I.value.capture({x:0,y:0,w:0,h:0})),{interval:150,signal:R.signal}),console.log("->changed"))}catch(c){c instanceof Error&&"ECANCEL"===c.message&&(L.value=te.Processing)}};(0,n.watch)((()=>L.value),(async()=>{if(L.value===te.Ready&&((0,b.l)("ready",null),(0,b.l)("state","ready")),L.value===te.Capture&&((0,b.l)("state","capture"),T.value&&M.activeWindow(T.value),console.log("capture"),F()),I.value){if(L.value===te.Processing){R.abort(),C&&C.drawImage(I.value.video,0,0,y.width,y.height);const e=C&&C.getImageData(0,0,y.width,y.height);e&&V.push({imageData:e,keepLastLine:!0}),I.value.stop(),console.log("processing"),(0,b.l)("state","processing"),N.resume(),T.value&&M.hwnd&&M.activeWindow(M.hwnd)}L.value===te.Finish&&(console.log("finish"),(0,b.l)("state","finish"),(0,b.l)("result",{result:h.value,dup:f.value,metadata:s}))}}));const W=async()=>{await Promise.all([i.reset(),o.reset()]),h.value=[],m.value=0,f.value=0,L.value=te.Ready,E=null,k=0,R=new AbortController,P.value=Date.now()},A=e=>{const{event:t}=e.data;switch(t){case"reset":W();break;case"start":I.value&&I.value.requestCapture();break}};return r||(window.addEventListener("message",A),(0,n.onBeforeUnmount)((()=>{window.removeEventListener("message",A)}))),(0,n.watch)([m,p,f],(()=>{(0,b.l)("progress",{scanned:m.value,...p.value,dup:f.value})})),{S:te,state:L,results:h,scanned:m,recognized:p,capture:w,dup:f,isTop:r,reset:W,webControl:M,webControlEnabled:T,cap:I,capKey:P,getScannerInstance:v.zG}}}),ie={loader:"loader-ed1218",scannerCssloadLoader:"scanner-cssload-loader-a98e2b",scannerCssloadLoaderInner:"scanner-cssload-loader-inner-a4c871",floatwindow:"floatwindow-b2c0ef",statusInner:"status-inner-e6d784"};const oe={};oe["$style"]=ie;const se=(0,C.Z)(le,[["render",r],["__cssModules",oe]]);var ce=se}}]);