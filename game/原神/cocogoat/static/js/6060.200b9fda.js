"use strict";(self["define"]=self["define"]||[]).push([[6060,7442],{36060:function(t,e,a){a.r(e),a.d(e,{default:function(){return k}});var o=a(60017),r=(a(43928),a(97442)),n=a(10311),s=a(85166);const i={class:"logo"},c={class:"content"},d={class:"title"},l={class:"username"},f={class:"status"};function h(t,e,a,o,r,s){const h=(0,n.resolveComponent)("fa-icon");return(0,n.openBlock)(),(0,n.createElementBlock)("div",{class:(0,n.normalizeClass)(t.$style.syncItemMsft)},[(0,n.createElementVNode)("div",i,[(0,n.createVNode)(h,{icon:["fab","microsoft"]})]),(0,n.createElementVNode)("div",c,[(0,n.createElementVNode)("div",d,[(0,n.createElementVNode)("div",l,"OneDrive - "+(0,n.toDisplayString)(t.provider.name),1),(0,n.createElementVNode)("div",f,(0,n.toDisplayString)(t.provider.user),1)])])],2)}var u=a(65890),p=a(48206);p.library.add(u.hVS);var m=(0,n.defineComponent)({props:{provider:{type:Object,required:!0}},setup(){return{}}}),w={syncItemMsft:"syncItemMsft-dbda1e"},y=a(14545);const g={};g["$style"]=w;const v=(0,y.Z)(m,[["render",h],["__cssModules",g]]);var A=v,b=a(22244);class T{constructor(t){(0,o.Z)(this,"component",(0,n.markRaw)(A)),(0,o.Z)(this,"data",void 0),(0,o.Z)(this,"name",""),(0,o.Z)(this,"user",""),this.data=t;const e=t.id_token,a=JSON.parse((0,s.Jx)(e.split(".")[1]));this.name=a.name,this.user=a.preferred_username}async enabled(){return{enabled:!0,reason:""}}async refreshToken(){if(Date.now()-this.data.last_updated<1e3*this.data.expires_in)return;const t=await fetch(await(0,r.HU)("/v2/aether/microsoft"),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:this.data.refresh_token})});try{if(200===t.status){const e=await t.json();if(e.refresh_token&&e.access_token){const t=e.id_token;Object.assign(this.data,e),this.data.id_token=t,this.data.last_updated=Date.now(),console.log("SYNC-ONEDRIVE","Token Refreshed")}}}catch(e){}}async info(){return{user:"debug",name:"debug",avatar:"",storage:[0,0]}}async set(t,e,{localLast:a,localNow:o,forceOverride:r}){await this.refreshToken();const n=`https://graph.microsoft.com/beta/me/drive/special/approot:/${t}.json`;if(!r&&a.getTime()>0&&null!==e){const e=await fetch(n,{method:"GET",headers:{Authorization:`Bearer ${this.data.access_token}`}});if(200===e.status){const r=await e.json(),n=new Date(r.lastModifiedDateTime);if(n>a)throw new b.s9(b.fS.CONFLICT,"conflict when saving ["+t+"]",{remoteLast:n,localLast:a,localNow:o,key:t})}}const s={value:e,lastModified:o.toISOString()},i=await fetch(`${n}${null===e?"":":/content"}?@microsoft.graph.conflictBehavior=replace`,{method:null===e?"DELETE":"PUT",headers:{Authorization:`Bearer ${this.data.access_token}`,"Content-Type":"application/json"},body:null===e?void 0:JSON.stringify(s,null,4)}),c=await i.text();if(200===i.status||201===i.status||204===i.status||404===i.status)return{value:e,lastModified:o};throw new b.s9(b.fS.OTHER,"OneDrive Sync Faild",c)}async get(t){await this.refreshToken();const e=`https://graph.microsoft.com/beta/me/drive/special/approot:/${t}.json:/content`,a=await fetch(e,{method:"GET",headers:{Authorization:`Bearer ${this.data.access_token}`}});if(404===a.status)return{value:null,lastModified:new Date(0)};if(200===a.status)try{const t=await a.json();return t}catch(r){return{value:null,lastModified:new Date(0)}}const o=await a.text();throw new b.s9(b.fS.OTHER,"OneDrive Sync Faild",{status:a.status,data:o})}async loadAll(){await this.refreshToken();const t="https://graph.microsoft.com/beta/me/drive/special/approot/children",e=await fetch(t,{method:"GET",headers:{Authorization:`Bearer ${this.data.access_token}`}});if(200===e.status){const t=await e.json(),o={};for(const e of t.value){if(!e.name.endsWith(".json"))continue;const t=`https://graph.microsoft.com/beta/me/drive/special/approot:/${e.name}:/content`,r=await fetch(t,{method:"GET",headers:{Authorization:`Bearer ${this.data.access_token}`}});try{if(200===r.status){const t=await r.json();t.lastModified=new Date(t.lastModified);const a=e.name.substr(0,e.name.length-5);o[a]=t}}catch(a){console.log(a)}}return o}throw new b.s9(b.fS.OTHER,"OneDrive Sync Faild",{status:e.status,data:await e.text()})}}var k=T},97442:function(t,e,a){a.d(e,{HU:function(){return l},ik:function(){return c},ts:function(){return s}});var o=a(10311);const r={global:"https://77.cocogoat.work",cn:"https://77.cocogoat.cn"};let n=navigator.language.startsWith("zh")?"cn":"global";const s=(0,o.ref)(""),i=(0,o.ref)("info"),c=(0,o.ref)("");let d;const l=async(t="",e="default")=>(d||(d=f(n),n=await d),await d,r["default"===e?n:e]+t),f=async t=>{const e=await r[t]+"/status";try{const t=await fetch(e);if(t.ok){const e=await t.json();if(s.value=e.msg,i.value=e.typ,c.value=e.smsg,r[e.region])return e.region}}catch(a){return console.error("API Region Probe Faild",a),"global"===t?"cn":"global"}return t}},85166:function(t,e,a){a.d(e,{Jx:function(){return b}});a(97791),a(670),a(80426),a(49743),a(36826),a(26263),a(77253);const o="function"===typeof atob,r="function"===typeof Buffer,n="function"===typeof TextDecoder?new TextDecoder:void 0,s=("function"===typeof TextEncoder&&new TextEncoder,"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="),i=Array.prototype.slice.call(s),c=(t=>{let e={};return t.forEach(((t,a)=>e[t]=a)),e})(i),d=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,l=String.fromCharCode.bind(String),f="function"===typeof Uint8Array.from?Uint8Array.from.bind(Uint8Array):(t,e=(t=>t))=>new Uint8Array(Array.prototype.slice.call(t,0).map(e)),h=t=>t.replace(/[^A-Za-z0-9\+\/]/g,""),u=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,p=t=>{switch(t.length){case 4:var e=(7&t.charCodeAt(0))<<18|(63&t.charCodeAt(1))<<12|(63&t.charCodeAt(2))<<6|63&t.charCodeAt(3),a=e-65536;return l(55296+(a>>>10))+l(56320+(1023&a));case 3:return l((15&t.charCodeAt(0))<<12|(63&t.charCodeAt(1))<<6|63&t.charCodeAt(2));default:return l((31&t.charCodeAt(0))<<6|63&t.charCodeAt(1))}},m=t=>t.replace(u,p),w=t=>{if(t=t.replace(/\s+/g,""),!d.test(t))throw new TypeError("malformed base64.");t+="==".slice(2-(3&t.length));let e,a,o,r="";for(let n=0;n<t.length;)e=c[t.charAt(n++)]<<18|c[t.charAt(n++)]<<12|(a=c[t.charAt(n++)])<<6|(o=c[t.charAt(n++)]),r+=64===a?l(e>>16&255):64===o?l(e>>16&255,e>>8&255):l(e>>16&255,e>>8&255,255&e);return r},y=o?t=>atob(h(t)):r?t=>Buffer.from(t,"base64").toString("binary"):w,g=r?t=>f(Buffer.from(t,"base64")):t=>f(y(t),(t=>t.charCodeAt(0))),v=r?t=>Buffer.from(t,"base64").toString("utf8"):n?t=>n.decode(g(t)):t=>m(y(t)),A=t=>h(t.replace(/[-_]/g,(t=>"-"==t?"+":"/"))),b=t=>v(A(t))}}]);